#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ—ï¸ PRINCIPAL ARCHITECT STANDARDS - PRE-COMMIT VALIDATION"
echo "======================================================="

# Check if this is a TypeScript file change
if git diff --cached --name-only | grep -E "\.(ts|tsx)$" > /dev/null; then
  echo "ğŸ“ TypeScript files detected. Running Principal Architect validation..."
  
  # Run TypeScript type checking
  echo "ğŸ” Type checking..."
  npm run type-check:shared
  if [ $? -ne 0 ]; then
    echo "âŒ PRINCIPAL ARCHITECT VIOLATION: TypeScript type errors detected"
    echo "Fix type errors before committing"
    exit 1
  fi
  
  # Run ESLint with Principal Architect standards
  echo "ğŸ” Linting with Principal Architect standards..."
  npm run lint:principal-architect
  if [ $? -ne 0 ]; then
    echo "âŒ PRINCIPAL ARCHITECT VIOLATION: ESLint errors detected"
    echo "Run 'npm run lint:fix' to auto-fix issues or manually resolve violations"
    exit 1
  fi
  
  # Check code formatting
  echo "ğŸ” Checking code formatting..."
  npm run format:check
  if [ $? -ne 0 ]; then
    echo "âŒ PRINCIPAL ARCHITECT VIOLATION: Code formatting issues detected"
    echo "Run 'npm run format' to fix formatting"
    exit 1
  fi
  
  # Validate performance constraints for voice AI files
  if git diff --cached --name-only | grep -E "voice.*\.(ts|tsx)$" > /dev/null; then
    echo "ğŸ™ï¸ Voice AI files detected. Validating performance constraints..."
    npm run validate:voice-ai
    if [ $? -ne 0 ]; then
      echo "âŒ VOICE AI VIOLATION: Performance constraint violations detected"
      exit 1
    fi
  fi
  
  # Validate financial accuracy for payment files
  if git diff --cached --name-only | grep -E "(payment|stripe|revenue).*\.(ts|tsx)$" > /dev/null; then
    echo "ğŸ’° Payment/Financial files detected. Validating accuracy standards..."
    npm run validate:payments
    if [ $? -ne 0 ]; then
      echo "âŒ FINANCIAL ACCURACY VIOLATION: Payment processing violations detected"
      exit 1
    fi
  fi
  
  echo "âœ… PRINCIPAL ARCHITECT STANDARDS: ALL VALIDATIONS PASSED"
  echo "ğŸ¯ Knuth Mathematical Precision: VERIFIED"
  echo "ğŸ”„ Dijkstra Algorithmic Elegance: VERIFIED"
  echo "âš¡ Torvalds Pragmatic Excellence: VERIFIED"
else
  echo "â„¹ï¸ No TypeScript files changed. Skipping Principal Architect validation."
fi

echo "ğŸš€ Commit approved by Principal Architect standards"