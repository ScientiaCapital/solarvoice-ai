// SolarVoice.ai Database Schema
// Voice-First AI Equipment Rental Platform for Solar & Energy Contractors
// Target: Solar, Solar+Roof, Solar+HVAC, Electrical+Solar+Battery+EV, General Contractors

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// =====================================================
// CORE USER & CONTRACTOR MODELS
// =====================================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  companyName       String?
  phoneNumber       String?
  preferredLanguage String    @default("en") // en or es
  role              UserRole  @default(CONTRACTOR)
  
  // Profile
  contractorProfile ContractorProfile?
  
  // Relationships
  rentals           Rental[]
  createdModels     EquipmentModel[] @relation("ModelCreator")
  favoriteModels    FavoriteModel[]
  voiceInteractions VoiceInteraction[]
  subscriptions     Subscription[]
  customAgents      CustomAgent[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([email])
}

enum UserRole {
  CONTRACTOR
  ENTERPRISE
  ADMIN
  DEVELOPER
}

model ContractorProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])
  
  // Company Information
  licenseNumbers    Json?    // State licenses: C-10, C-46, B-1, etc.
  insuranceCoverage Json?
  bondingCapacity   Decimal? @db.Decimal(12, 2)
  
  // Trade Specializations - What they actually do
  tradeTypes        TradeType[]
  certifications    String[] // NABCEP, EPA 608, C-10, etc.
  
  // Trust Metrics
  completedProjects Int      @default(0)
  totalMwInstalled  Decimal  @default(0) @db.Decimal(10, 2)
  customerRating    Decimal? @db.Decimal(3, 2)
  verifiedInstaller Boolean  @default(false)
  trustScore        Int      @default(50) // 0-100
  
  // Service Areas
  serviceZipCodes   String[]
  serviceStates     String[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

enum TradeType {
  SOLAR_ONLY              // Pure solar
  SOLAR_ROOF              // Solar + Roofing
  SOLAR_HVAC              // Solar + HVAC
  SOLAR_ELECTRICAL        // Electrical + Solar
  SOLAR_BATTERY           // Solar + Battery Storage
  SOLAR_EV                // Solar + EV Charging
  SOLAR_GENERATOR         // Solar + Generator Backup
  WHOLE_HOME_ENERGY       // Complete home energy retrofit
  NET_ZERO_COMMERCIAL     // Net-zero commercial projects
  UTILITY_SCALE           // Large solar farms
}

// =====================================================
// AI EQUIPMENT MODELS (VOICE-FIRST CATALOG)
// =====================================================

model EquipmentModel {
  id          String   @id @default(cuid())
  modelCode   String   @unique // CPM-24, WHE-24, SRC-24, etc.
  name        String
  description String   @db.Text
  
  // Category for Solar/Energy Focus
  category    ModelCategory
  tradeTypes  TradeType[]
  
  // Project Size Range
  projectSizeMin Int?  // in kW
  projectSizeMax Int?  // in kW (null for unlimited)
  
  // Voice Configuration (ElevenLabs)
  voiceId        String  // ElevenLabs voice ID
  spanishVoiceId String? // Spanish voice variant
  languages      String[] @default(["en"])
  voicePersonality String? // Professional, Friendly, Technical, Authoritative
  
  // Equipment Rental Pricing (like United Rentals)
  hourlyRate   Decimal @db.Decimal(10, 2)
  dailyRate    Decimal @db.Decimal(10, 2)
  weeklyRate   Decimal @db.Decimal(10, 2)
  monthlyRate  Decimal @db.Decimal(10, 2)
  
  // Marketplace Fields (for custom models)
  creatorId    String?
  creator      User?    @relation("ModelCreator", fields: [creatorId], references: [id])
  isMarketplace Boolean @default(false)
  revenueShare  Decimal? @db.Decimal(3, 2) // 0.70 = 70% to creator
  
  // Knowledge & Capabilities
  knowledgeBases KnowledgeBase[]
  capabilities   String[] // ["permit_checking", "roi_calculation", "load_analysis"]
  integrations   String[] // ["ServiceTitan", "Aurora", "OpenSolar"]
  
  // Usage Metrics
  totalRentals   Int     @default(0)
  totalRevenue   Decimal @default(0) @db.Decimal(12, 2)
  avgRating      Decimal? @db.Decimal(3, 2)
  
  // Relationships
  rentals        Rental[]
  favorites      FavoriteModel[]
  voiceCommands  VoiceCommand[]
  
  isActive       Boolean @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([modelCode])
  @@index([category])
}

enum ModelCategory {
  // Residential Focus
  RESIDENTIAL           // <50kW systems
  RESI_COMMERCIAL      // 50-250kW
  
  // Commercial Focus
  COMMERCIAL           // 250kW-1MW
  BIG_COMMERCIAL      // 1-2MW
  C_AND_I             // 2-10MW Commercial & Industrial
  
  // Large Scale
  INDUSTRIAL          // 10-50MW
  UTILITY            // 50MW+ solar farms
  
  // Multi-Trade Specialists
  WHOLE_HOME         // Complete energy retrofits
  MULTI_TRADE        // Solar + other trades
  NET_ZERO           // Net-zero specialists
}

// =====================================================
// KNOWLEDGE BASE (Equipment Intelligence)
// =====================================================

model KnowledgeBase {
  id           String         @id @default(cuid())
  modelId      String
  model        EquipmentModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  
  documentType DocumentType
  title        String
  content      String         @db.Text
  url          String?
  
  // Structured Knowledge
  category     String?        // permits, codes, products, procedures, incentives
  tags         String[]       // ["ITC", "NEM3.0", "Title24"]
  
  // Metadata for search
  metadata     Json?
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  @@index([modelId])
  @@index([category])
}

enum DocumentType {
  PDF
  TXT
  URL
  MANUAL
  CODE_REGULATION    // NEC, Title 24, etc.
  PERMIT_GUIDE
  INCENTIVE_PROGRAM
  UTILITY_TARIFF
  PRODUCT_SPEC
  FAQ
}

// =====================================================
// RENTAL TRANSACTIONS (Equipment Rental Model)
// =====================================================

model Rental {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  modelId     String
  model       EquipmentModel @relation(fields: [modelId], references: [id])
  
  // Rental Terms (like equipment rental)
  rentalType  RentalType
  duration    Int          // in hours, days, weeks, or months
  totalCost   Decimal      @db.Decimal(10, 2)
  
  // Project Information
  projectName String?
  projectSize Decimal?     @db.Decimal(10, 2) // in kW
  projectType TradeType?
  projectZip  String?
  
  // Voice Usage Tracking
  languageUsed      String   @default("en")
  voiceMinutesUsed  Int      @default(0)
  conversationCount Int      @default(0)
  
  // Status
  status      RentalStatus @default(ACTIVE)
  startedAt   DateTime     @default(now())
  endsAt      DateTime
  completedAt DateTime?
  
  // Relationships
  voiceInteractions VoiceInteraction[]
  invoices          Invoice[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([userId])
  @@index([modelId])
  @@index([status])
}

enum RentalType {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  PROJECT     // For long-term projects
}

enum RentalStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  EXTENDED
}

// =====================================================
// VOICE INTERACTIONS (Core Feature)
// =====================================================

model VoiceInteraction {
  id         String   @id @default(cuid())
  rentalId   String?
  rental     Rental?  @relation(fields: [rentalId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  
  // Interaction Details
  transcript String   @db.Text
  language   String   @default("en")
  intent     String?  // calculate_roi, check_permit, find_incentives
  confidence Decimal? @db.Decimal(3, 2)
  
  // Context
  projectContext Json?   // Project details at time of interaction
  
  // Performance
  durationSeconds Int
  responseTime    Int?     // in milliseconds
  successful      Boolean  @default(true)
  errorMessage    String?
  
  // ElevenLabs Integration
  voiceId         String?
  audioUrl        String?  // Recording URL if saved
  
  // Post-call Analysis (from webhooks)
  summary         String?  @db.Text
  actionItems     Json?    // Tasks identified
  followUpNeeded  Boolean  @default(false)
  leadQuality     String?  // HOT, WARM, COLD
  
  createdAt       DateTime @default(now())
  
  @@index([rentalId])
  @@index([userId])
  @@index([createdAt])
  @@index([intent])
}

// =====================================================
// VOICE COMMANDS (Bilingual Templates)
// =====================================================

model VoiceCommand {
  id          String         @id @default(cuid())
  modelId     String
  model       EquipmentModel @relation(fields: [modelId], references: [id], onDelete: Cascade)
  
  // Bilingual Commands
  commandEn   String         // "What permits do I need for 500kW commercial?"
  commandEs   String?        // "¿Qué permisos necesito para 500kW comercial?"
  
  // Intent and Parameters
  intent      String         // permit_check, roi_calc, incentive_search
  category    String         // permits, financing, technical, sales
  parameters  Json?          // Required parameters
  
  // Response Templates
  responseEn  String         @db.Text
  responseEs  String?        @db.Text
  
  // Dynamic Variables Support
  variables   String[]       // ["project_size", "location", "utility"]
  
  // Usage Tracking
  usageCount  Int            @default(0)
  successRate Decimal?       @db.Decimal(3, 2)
  
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@index([modelId])
  @@index([intent])
  @@index([category])
}

// =====================================================
// SUBSCRIPTIONS (Contractor Plans)
// =====================================================

model Subscription {
  id             String           @id @default(cuid())
  userId         String
  user           User             @relation(fields: [userId], references: [id])
  plan           SubscriptionPlan
  
  // Billing
  monthlyPrice   Decimal          @db.Decimal(10, 2)
  billingCycle   BillingCycle     @default(MONTHLY)
  
  // Limits & Features
  modelsIncluded Int              // Number of models included
  voiceMinutes   Int              // Monthly voice minutes
  customModels   Int              @default(0) // How many custom models allowed
  
  // Status
  status         SubscriptionStatus @default(ACTIVE)
  startDate      DateTime         @default(now())
  endDate        DateTime?
  cancelledAt    DateTime?
  
  // Stripe Integration
  stripeSubscriptionId String?    @unique
  stripeCustomerId     String?
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  @@index([userId])
  @@index([status])
}

enum SubscriptionPlan {
  SOLO       // $299/month - 5 models, 1000 voice minutes
  TEAM       // $799/month - 15 models, 5000 voice minutes
  ENTERPRISE // $2499/month - Unlimited models, unlimited minutes
  CUSTOM     // Custom pricing
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
  TRIAL
}

// =====================================================
// BILLING & INVOICES
// =====================================================

model Invoice {
  id          String        @id @default(cuid())
  rentalId    String
  rental      Rental        @relation(fields: [rentalId], references: [id])
  
  // Amounts
  subtotal    Decimal       @db.Decimal(10, 2)
  tax         Decimal       @db.Decimal(10, 2)
  total       Decimal       @db.Decimal(10, 2)
  
  // Payment
  status      InvoiceStatus @default(PENDING)
  paidAt      DateTime?
  dueDate     DateTime
  
  // Stripe Integration
  stripeInvoiceId String?   @unique
  stripePaymentIntentId String?
  
  // Details
  lineItems   Json?         // Detailed breakdown
  notes       String?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([rentalId])
  @@index([status])
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// =====================================================
// FAVORITES & USER PREFERENCES
// =====================================================

model FavoriteModel {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  modelId   String
  model     EquipmentModel @relation(fields: [modelId], references: [id])
  
  notes     String?        // User notes about why they like this model
  
  createdAt DateTime       @default(now())
  
  @@unique([userId, modelId])
  @@index([userId])
}

// =====================================================
// ANALYTICS & METRICS
// =====================================================

model DailyAnalytics {
  id          String   @id @default(cuid())
  date        DateTime @unique @db.Date
  
  // Platform Metrics
  totalRentals         Int
  totalRevenue         Decimal @db.Decimal(12, 2)
  activeUsers          Int
  newSignups           Int
  
  // Voice Metrics
  totalVoiceMinutes    Int
  totalConversations   Int
  avgConversationTime  Int // in seconds
  
  // Language Breakdown
  englishMinutes       Int
  spanishMinutes       Int
  
  // Model Performance
  topModels            Json // Array of top 10 models
  
  // Trade Type Breakdown
  tradeTypeMetrics     Json // Usage by trade type
  
  createdAt            DateTime @default(now())
  
  @@index([date])
}

model ModelPerformance {
  id          String         @id @default(cuid())
  modelId     String
  date        DateTime       @db.Date
  
  // Usage
  rentalsCount    Int        @default(0)
  voiceMinutes    Int        @default(0)
  revenue         Decimal    @db.Decimal(10, 2)
  
  // Quality
  avgRating       Decimal?   @db.Decimal(3, 2)
  successRate     Decimal?   @db.Decimal(3, 2)
  
  // Language Split
  englishPercent  Int        @default(100)
  spanishPercent  Int        @default(0)
  
  createdAt       DateTime   @default(now())
  
  @@unique([modelId, date])
  @@index([modelId])
  @@index([date])
}

// =====================================================
// CUSTOM AGENTS (User-Created Voice Agents)
// =====================================================

model CustomAgent {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // Agent Details
  name            String
  prompt          String    // Original creation prompt
  role            String
  description     String?
  
  // Voice Configuration
  languages       String[]  // e.g., ["en", "es"]
  voiceId         String    // ElevenLabs voice ID
  voiceSettings   Json?     // Additional voice config
  
  // Knowledge & Capabilities
  knowledgeBases  String[]  // Selected knowledge base IDs
  capabilities    String[]  // List of capabilities
  
  // Status & Usage
  isActive        Boolean   @default(true)
  testMode        Boolean   @default(true) // In testing vs deployed
  usageMinutes    Int       @default(0)
  lastUsed        DateTime?
  
  // Pricing (for billing)
  monthlyPrice    Decimal   @default(99) @db.Decimal(10, 2)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relationships
  interactions    AgentInteraction[]
  
  @@index([userId])
  @@index([isActive])
}

// Track interactions with custom agents
model AgentInteraction {
  id            String      @id @default(cuid())
  agentId       String
  agent         CustomAgent @relation(fields: [agentId], references: [id])
  
  // Interaction Details
  sessionId     String      // Group related interactions
  inputText     String?     // User's voice input (transcribed)
  outputText    String?     // Agent's response
  language      String      @default("en")
  
  // Voice Metrics
  inputDuration Int?        // Duration in seconds
  outputDuration Int?       // Duration in seconds
  confidence    Decimal?    @db.Decimal(3, 2) // Recognition confidence
  
  // Context
  context       Json?       // Conversation context/state
  metadata      Json?       // Additional metadata
  
  createdAt     DateTime    @default(now())
  
  @@index([agentId])
  @@index([sessionId])
  @@index([createdAt])
}